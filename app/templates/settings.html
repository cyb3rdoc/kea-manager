{% extends "base.html" %}

{% block title %}Settings - KEA DHCP Manager{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <h2 style="color: #333;">DHCP Settings</h2>
        <button class="btn btn-danger" onclick="restartService()">Restart Service</button>
    </div>

    <!-- Global Settings -->
    <div class="card" style="margin-bottom: 2rem;">
        <h3 style="color: #333; margin-bottom: 1.5rem;">Global Settings</h3>
        <form method="POST" action="{{ url_for('update_settings') }}">
            <div class="form-group">
                <label for="interfaces">Network Interfaces (comma-separated):</label>
                <input type="text" id="interfaces" name="interfaces"
                       value="{% if config.Dhcp4 and config.Dhcp4['interfaces-config'] %}{{ config.Dhcp4['interfaces-config']['interfaces']|join(', ') }}{% else %}*{% endif %}"
                       placeholder="*, eth0, wlan0">
            </div>

            <div class="grid">
                <div class="form-group">
                    <label for="renew_timer">Renew Timer (seconds):</label>
                    <input type="number" id="renew_timer" name="renew_timer"
                           value="{{ config.Dhcp4['renew-timer'] if config.Dhcp4 and config.Dhcp4.get('renew-timer') else 900 }}"
                           min="60" max="86400">
                </div>

                <div class="form-group">
                    <label for="rebind_timer">Rebind Timer (seconds):</label>
                    <input type="number" id="rebind_timer" name="rebind_timer"
                           value="{{ config.Dhcp4['rebind-timer'] if config.Dhcp4 and config.Dhcp4.get('rebind-timer') else 1800 }}"
                           min="120" max="86400">
                </div>

                <div class="form-group">
                    <label for="valid_lifetime">Lease Duration (seconds):</label>
                    <input type="number" id="valid_lifetime" name="valid_lifetime"
                           value="{{ config.Dhcp4['valid-lifetime'] if config.Dhcp4 and config.Dhcp4.get('valid-lifetime') else 3600 }}"
                           min="300" max="604800">
                </div>
            </div>

            <div style="text-align: center;">
                <button type="submit" class="btn btn-success">Update Global Settings</button>
            </div>
        </form>
    </div>

    <!-- Subnet Management -->
    <div class="card" style="margin-bottom: 2rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h3 style="color: #333;">Subnets</h3>
            <button class="btn" onclick="toggleAddSubnet()">Add New Subnet</button>
        </div>

        <!-- Add Subnet Form (Hidden by default) -->
        <div id="add-subnet-form" style="display: none; margin-bottom: 2rem; padding: 1.5rem; background: #f8f9fa; border-radius: 12px;">
            <h4 style="margin-bottom: 1rem; color: #333;">Add New Subnet</h4>
            <form method="POST" action="{{ url_for('add_subnet') }}">
                <div class="grid">
                    <div class="form-group">
                        <label for="subnet">Subnet (CIDR):</label>
                        <input type="text" id="subnet" name="subnet" required
                               placeholder="192.168.1.0/24">
                    </div>

                    <div class="form-group">
                        <label for="pool_start">Pool Start IP:</label>
                        <input type="text" id="pool_start" name="pool_start" required
                               placeholder="192.168.1.100">
                    </div>

                    <div class="form-group">
                        <label for="pool_end">Pool End IP:</label>
                        <input type="text" id="pool_end" name="pool_end" required
                               placeholder="192.168.1.200">
                    </div>

                    <div class="form-group">
                        <label for="gateway">Gateway IP:</label>
                        <input type="text" id="gateway" name="gateway"
                               placeholder="192.168.1.1">
                    </div>

                    <div class="form-group">
                        <label for="dns_servers">DNS Servers (comma-separated):</label>
                        <input type="text" id="dns_servers" name="dns_servers"
                               placeholder="8.8.8.8, 8.8.4.4">
                    </div>

                    <div class="form-group">
                        <label for="domain_name">Domain Name:</label>
                        <input type="text" id="domain_name" name="domain_name"
                               placeholder="local">
                    </div>
                </div>

                <div style="text-align: center;">
                    <button type="submit" class="btn btn-success">Add Subnet</button>
                    <button type="button" class="btn" onclick="toggleAddSubnet()">Cancel</button>
                </div>
            </form>
        </div>

        <!-- Existing Subnets -->
        {% if config.Dhcp4 and config.Dhcp4.subnet4 %}
            {% for subnet in config.Dhcp4.subnet4 %}
            <div class="card" style="margin-bottom: 1.5rem; border-left: 4px solid #667eea;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                    <div>
                        <h4 style="color: #333; margin-bottom: 0.5rem;">
                            Subnet {{ subnet.id }} - {{ subnet.subnet }}
                        </h4>
                        {% if subnet.pools %}
                            <p><strong>Pool:</strong> {{ subnet.pools[0].pool }}</p>
                        {% endif %}
                        {% if subnet['option-data'] %}
                            {% for option in subnet['option-data'] %}
                                <p><strong>{{ option.name|title }}:</strong> {{ option.data }}</p>
                            {% endfor %}
                        {% endif %}
                    </div>
                    <form method="POST" action="{{ url_for('delete_subnet', subnet_index=loop.index0) }}" style="display: inline;">
                        <button type="submit" class="btn btn-danger"
                                onclick="return confirm('Are you sure you want to delete this subnet?')">
                            Delete
                        </button>
                    </form>
                </div>

                <!-- Static Reservations -->
                <div style="margin-top: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h5 style="color: #333;">Static Reservations</h5>
                        <button class="btn" onclick="toggleAddReservation({{ loop.index0 }})">Add Reservation</button>
                    </div>

                    <!-- Add Reservation Form -->
                    <div id="add-reservation-{{ loop.index0 }}" style="display: none; margin-bottom: 1rem; padding: 1rem; background: #e9ecef; border-radius: 8px;">
                        <form method="POST" action="{{ url_for('add_reservation') }}">
                            <input type="hidden" name="subnet_index" value="{{ loop.index0 }}">
                            <div class="grid">
                                <div class="form-group">
                                    <label>MAC Address:</label>
                                    <input type="text" name="mac_address" required
                                           placeholder="aa:bb:cc:dd:ee:ff">
                                </div>
                                <div class="form-group">
                                    <label>IP Address:</label>
                                    <input type="text" name="ip_address" required
                                           placeholder="192.168.1.50">
                                </div>
                                <div class="form-group">
                                    <label>Hostname (optional):</label>
                                    <input type="text" name="hostname"
                                           placeholder="server1">
                                </div>
                            </div>
                            <div style="text-align: center; margin-top: 1rem;">
                                <button type="submit" class="btn btn-success">Add Reservation</button>
                                <button type="button" class="btn" onclick="toggleAddReservation({{ loop.index0 }})">Cancel</button>
                            </div>
                        </form>
                    </div>

                    <!-- Existing Reservations -->
                    {% if subnet.reservations %}
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; margin-top: 1rem;">
                                <thead>
                                    <tr style="background: #f8f9fa;">
                                        <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #dee2e6;">MAC Address</th>
                                        <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #dee2e6;">IP Address</th>
                                        <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #dee2e6;">Hostname</th>
                                        <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #dee2e6;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for reservation in subnet.reservations %}
                                    <tr>
                                        <td style="padding: 0.75rem; border-bottom: 1px solid #dee2e6;">{{ reservation['hw-address'] }}</td>
                                        <td style="padding: 0.75rem; border-bottom: 1px solid #dee2e6;">{{ reservation['ip-address'] }}</td>
                                        <td style="padding: 0.75rem; border-bottom: 1px solid #dee2e6;">{{ reservation.hostname or '-' }}</td>
                                        <td style="padding: 0.75rem; border-bottom: 1px solid #dee2e6;">
                                            <form method="POST" action="{{ url_for('delete_reservation', subnet_index=loop.index0, reservation_index=loop.index0) }}" style="display: inline;">
                                                <button type="submit" class="btn btn-danger" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;"
                                                        onclick="return confirm('Are you sure you want to delete this reservation?')">
                                                    Delete
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p style="color: #666; text-align: center; padding: 1rem;">No static reservations configured</p>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        {% else %}
            <p style="text-align: center; color: #666; padding: 2rem;">No subnets configured. Add your first subnet above.</p>
        {% endif %}
    </div>

    <div id="message" style="margin-top: 2rem;"></div>
</div>

<script>
function toggleAddSubnet() {
    const form = document.getElementById('add-subnet-form');
    form.style.display = form.style.display === 'none' ? 'block' : 'none';
}

function toggleAddReservation(subnetIndex) {
    const form = document.getElementById('add-reservation-' + subnetIndex);
    form.style.display = form.style.display === 'none' ? 'block' : 'none';
}

function restartService() {
    if (confirm('Are you sure you want to restart the DHCP service?')) {
        fetch('/restart-service', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            const messageDiv = document.getElementById('message');
            if (data.success) {
                messageDiv.innerHTML = '<div class="alert alert-success">' + data.message + '</div>';
            } else {
                messageDiv.innerHTML = '<div class="alert alert-error">Error: ' + data.error + '</div>';
            }
        })
        .catch(error => {
            document.getElementById('message').innerHTML = '<div class="alert alert-error">Network error: ' + error + '</div>';
        });
    }
}
</script>
{% endblock %}
